# Менеджер для разработки проектов на odoo

## Цель проекта
Основная цель проекта - создать инструмент для разработчика на платформе odoo, который будет удовлетворять следующим требованиям:
- не зависеть от операционной системы
- по возможности не зависеть от архитектуры процессора (Для примера запуск на MacOS на базе M1)
- для передачи всей информации о проекте, достаточно передать только `config.json` разработчику, он на его базе сможет легко подготовить новое окружение в полностью автоматическом режиме
- иметь удобные инструменты, которые часто необходимы разработчику, например:
    - быстрое удаление БД
    - быстрое восстановление БД из архива
    - создание новой БД со своими настройками (страна, язык, демо-данные и прочее)
    - смена пароля для указанного логина
    - ... и многое другое
    - механизмы для расширения функционала, на будущее

## Подготовка
вам необходимо скачать и установить следующие программы:
- [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- [git](https://git-scm.com/)
- [python3](https://www.python.org/)
- [Visual Studio Code](https://code.visualstudio.com/)

Далее вам обязательно надо клонировать к себе на компьютер git репозиторий системы odoo. Открываем командную строку и вводим команду

```
cd /путь/к/домашнему/каталогу
git clone https://github.com/odoo/odoo.git
```

Пример для Windows:
```
cd C:\Users\User
git clone https://github.com/odoo/odoo.git
```

Пример для Mac:
```
cd /Users/User
git clone https://github.com/odoo/odoo.git
```

Пример для Linux:
```
cd /home/user
git clone https://github.com/odoo/odoo.git
```

Создаете папку где у вас будет располагаться новый проект. В конца имени проекта я добавляю еще через дефис номер версии odoo. Например `odoo_demo_project-16`. Это связано с тем, что разница между версиями весьма существенна и их нужно именно так и рассматривать. В этом каталоге инициируете новый проект с помощью команды параметра `--init`:

```bash
python3 /путь/к/клонированному/odoo_dev_project/docker_start.py --init
```

## Параметры .env:
В каталоге с проектом так же необходимо правильно заполнить файл `.env`(он есть в этом проекте) в котором буду указаны пути к соотвествующим каталогам
- `BACKUP_DIR` - каталог в котором находятся архивы. Используется для того, чтобы с помощью параметров командной строки указать имя базы для восстановления и тогда система будет искать архив с указанным именем в этом каталоге, или при сохранении базы в архив, он появится в этом каталоге, может применяться для всех проектов
- `ODOO_SRC_DIR` - Каталог в котором должен находится полный клон репозитория самой платформы `odoo`. Я обычно его складываю в профиль своего пользователя, будет использоваться всеми проектами.
- `ODOO_PROJECTS_DIR` - создайте каталоге, в котором будут создаваться клоны всех используемых репозиториев. Нужно только его создать и указать путь к этому каталогу, дальше система сама клонирует в него все репозитории и расположит их так, чтобы не возникало конфликтов
- `PATH_TO_SSH_KEY` = если, по каким либо причинам у вас не получается добавить в ssh агент свой ключ для репозитория, то можете указать путь к нему здесь. На данный момент будет использоваться один ключ для всех репозиториев
- `ODOO_PORT` - порт на котором по умолчанию будет запускаться odoo на адресе 127.0.0.1
- `POSTGRES_PORT` - порт на котором по умолчанию будет запускаться СУБД PostgreSQL на адресе 127.0.0.1
- `DEBUGGER_PORT` - порт на котором по умолчанию будет запускаться отладчик на адресе 127.0.0.1

Пример для Windows:
```conf
BACKUP_DIR=C:\Users\User\odoo_backups
ODOO_SRC_DIR=C:\Users\User\odoo
ODOO_PROJECTS_DIR=C:\Users\User\odoo_projects
PATH_TO_SSH_KEY=C:\Users\User\.ssh\my_ssh_key
ODOO_PORT=8069
POSTGRES_PORT=5432
DEBUGGER_PORT=5678
```

## Как начать работать

Запускаем `VSCode` затем через меню Файл - Открыть (File - Open Folder) Каталог, открываем ранее созданный каталог со скопированными в него файлами данного проекта `odoo_demo_project-16`.

Теперь запускаем терминал через меню Терминал - Создать Терминал (Terminal - New Terminal) и уже в нем вводите указанные ниже команды. Если кто-то, глядя на python скрипт захочет запустить его внутри виртуального окружения, то не надо этого делать. В данном случае он используется вместо системных скриптовых языков и вы только усложните себе жизнь. Виртуальное окружение для проекта будет установлено внутрь контейнера в следующих шагах

Теперь надо подготовить образ Docker
```bash
python3 /путь/к/клонированному/odoo_dev_project/docker_start.py --build_image
```
Эта команда создаст образ
Затем надо подготовить виртуальное окружение внутри самого контейнера, для этого запускаем следующую команду:
```bash
python3 /путь/к/клонированному/odoo_dev_project/docker_start.py --pip_install
```
Система подготовит и установит все необходимые пакеты для запуска odoo
После этого можно запустить odoo в режиме разработчика
```bash
python3 /путь/к/клонированному/odoo_dev_project/docker_start.py -d new_db -i -u
```
Данная команда запустит odoo внутри Docker контейнера и создаст новую базу с именем new_db и установит туда модуль из указанного проекта

После этого вы можете открыть в браузере адрес `http://127.0.0.1:8069` и увидите окно входа в систему.

## Параметры config.json:

- `init_modules` - Строка. Параметр, в котором указываются модули через запятую, без пробелов, которые будут про-инициированы(установлены) при (пере)запуске системы.
- `update_modules` - Строка. Параметр, в котором указываются модули через запятую, без пробелов, которые будут обновлены при (пере)запуске системы
- `db_creation_data` - Объект. Параметры которые определяют создание новой базы
    - `db_lang` - Строка. Укажите язык системы по умолчанию про создании новой базы, например: `"en_US"` или `"ru_RU"`
    - `db_country_code` - Строка или `false` Укажите код страны по умолчанию про создании новой базы, например:`"ru"`
    - `create_demo` - Булево. Указывает на то, нужно ли создавать в системе демо данные при создании новой базы.
    - `db_default_admin_login` - Строка. Логин для учетной записи администратора
    - `db_default_admin_password` - Строка. Пароль для учетной записи администратора
- `odoo_version` - Строка. Версия системы. Примеры: `"16.0"`, `"15.0"`, `"11.0"`
- `update_git_repos` - Булево. Указывает на то, будут ли обновлены репозитории зависимостей и самой odoo при перезапуске системы
- `clean_git_repos` - Булево. Указывает на то, будут ли при перезапуске сбрасываться изменения в самой odoo и проектах зависимостей
- `check_system` - Булево. Указывает на то, будет ли запускаться проверка системы при старте. Полезно для новичков. Проверяет наличие устновленного git, docker и docker-compose.
- `developing_project` - Строка. Ссылка на проект, который вы разрабатываете. Пример: `"git@github.com:aayartsev/odoo_demo_project.git"`
- `pre_commit_map_files` - Список. Список файлов для системы `pre-commit`, которые выносятся из проекта и пробрасываются туда через сопоставление файлов docker. Нужно для работы не на Linux системах
- `dependencies` - Список. Список ссылок на репозитории проектов, от которых зависит ваш проект
- `requirements_txt` - Список. Список python модулей, каждый элемент может оформляться так же как и строка в файле requirements.txt
- `dev_mode` - Можно указать через запятую [параметры для разработчиков](https://www.odoo.com/documentation/16.0/developer/reference/cli.html?highlight=dev#cmdoption-odoo-bin-dev). Смотрите официальную документацию для своей версии odoo
- `db_manager_password` - пароль для менеджера баз данных


В проекте уже лежит настроенный пример `config.json`, который расчитан на работу с учебным демо-проектом `https://github.com/aayartsev/odoo_demo_project`

## Параметры командной строки

- `--init` - инициировать проект в текущем каталоге.
- `-d` - указать имя базы данных для работы, если такой базы не существует, она будет создана автоматически, на основании параметров `db_creation_data` параметра файла конфигурации `config.json`
- `-i` - параметр указывает на то что нужно проинициализировать модули указанные в параметре `init_modules` файла конфигурации `config.json`
- `u` - параметр указывает на то что нужно обновить модули указанные в параметре `update_modules` файла конфигурации `config.json`
- `-t` - запустит тесты модулей указанных в параметре `init_modules` и `update_modules` файла конфигурации `config.json`, работает только при использовании параметров `-d`, `-i`, `-u`, если база создается с нуля, то для всех устанавливаемых модулей будут запущены тесты, это может занять много времени
- `--get_dbs_list` - выводит список баз данных
- `--db-restore` - система попытается восстановить архив БД в качестве параметра указывается путь к архиву, относительно каталога, указанного в параметре `backups/localdir` файла конфигурации `config.json`, имя БД при восстановлении бу[дет взято из параметра `-d`
- `--db-drop` - в качестве параметра указывается имя базы данных, которую необходимо удалить, если использовать совместно с флагами `-d`, `-i`, `-u`, и указать одно и тоже имя БД, то система сначала удалит базу, а затем создаст новую с таким же именем и установит указанные модули
- `--translate` - Принимает в качестве параметра код языка, например `ru_RU`, при использовании данного параметра, система добавит соответствующий язык в систему и обновит все термины из модулей указанных в параметре `init_modules` и `update_modules` файла конфигурации `config.json`, работает только при использовании параметров `-d`, `-i`, `-u`
- `--pip_install` - указывает системе на то, что нужно установить зависимости для указанной в параметре `odoo_version` версии odoo и зависимостей указанных в файле `requirements.txt` в каталоге `dev_project`.
- `--start_precommit` - запускает проверку прекоммита для разрабатываемого проекта, указанного в параметре `developing_project` файла конфигурации `config.json`.
- `--build_image` - запустит сборку образа Docker для вашего проекта
- `--set_admin_pass` - при указании значения данного параметра, у учетной записи администратора(пользователь с id = 2) будет изменен пароль и логин на указанные в параметре `db_default_admin_login` и `db_default_admin_password` в файле конфигурации `config.json`. Обязательно нужно указать имя базы для которой вы хотите поменять пароль и использовать параметр `-d имя_базы`